<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Album Fotografico - Diario delle Memorie</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <style>
    html, body { margin:0; padding:0; height:100%; }
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:#020617;   /* ✅ blu scuro fisso (niente sfondo foto) */
      color:#e5e7eb;
    }

    .page{
      min-height:100vh;
      padding:22px 16px 28px;
      box-sizing:border-box;
      max-width:980px;
      margin:0 auto;
    }

    h1{
      font-size:1.35rem;
      margin:0 0 10px;
      text-align:center;
      text-shadow: 0 2px 6px rgba(0,0,0,0.6);
    }

    /* TOPBAR sticky */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      padding: 10px 0 12px;
      margin: 10px 0 16px;
      background: linear-gradient(to bottom, rgba(2,6,23,0.92), rgba(2,6,23,0.0));
      backdrop-filter: blur(6px);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 14px;
      border-radius:999px;
      background: rgba(15, 23, 42, 0.70);
      color:#e5e7eb;
      text-decoration:none;
      box-shadow: 0 6px 14px rgba(0,0,0,0.35);
      font-weight:700;
      font-size:0.85rem;
      -webkit-tap-highlight-color: transparent;
    }
    .pill.add{ background: rgba(15, 23, 42, 0.85); }
    .pill .plus{
      width:18px;
      height:18px;
      border-radius:50%;
      background:#22c55e;
      color:#052e16;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:0.95rem;
      line-height:1;
      flex:0 0 auto;
    }

    /* GRIGLIA */
    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    @media (min-width: 720px){
      .grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }

    .ph{
      border-radius: 16px;
      overflow:hidden;                 /* ✅ niente bordi/uscite */
      aspect-ratio: 1 / 1;
      background: rgba(15, 23, 42, 0.55);
      box-shadow: 0 8px 16px rgba(0,0,0,0.35);
      position: relative;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    /* ✅ immagine riempie completamente */
    .ph img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      margin: 0;
      padding: 0;
    }

    /* MODAL */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.78);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 200;
      padding: 14px;
      box-sizing: border-box;
    }
    .modal.open{ display:flex; }

    .viewer{
      width: min(980px, 100%);
      max-height: 90vh;
      background: rgba(2,6,23,0.92);
      border-radius: 18px;
      overflow:hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,0.6);
      position: relative;
    }

    .viewer img{
      width: 100%;
      height: 70vh;
      max-height: 70vh;
      object-fit: contain;
      display:block;
      background: #000;
    }

    .viewer-footer{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      font-size: 0.9rem;
      opacity: 0.95;
    }
    .meta{
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .navbtn{
      border: 0;
      background: rgba(15, 23, 42, 0.85);
      color:#e5e7eb;
      padding: 10px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 800;
      box-shadow: 0 8px 16px rgba(0,0,0,0.35);
    }
    .navbtn:active{ transform: scale(0.99); }

    .closebtn{
      position:absolute;
      top: 10px;
      right: 10px;
      border: 0;
      background: rgba(15, 23, 42, 0.85);
      color:#e5e7eb;
      width: 40px;
      height: 40px;
      border-radius: 999px;
      cursor:pointer;
      font-size: 18px;
      font-weight: 900;
      box-shadow: 0 8px 16px rgba(0,0,0,0.35);
      display:flex;
      align-items:center;
      justify-content:center;
    }
  </style>
</head>

<body>
  <div class="page">
    <h1>Album Fotografico</h1>

    <div class="topbar">
      <a class="pill" href="diario.html">← Torna al Diario</a>

      <a class="pill add"
         href="https://tally.so/r/aQ4B7Z"
         target="_blank" rel="noopener">
        <span class="plus">+</span>
        <span>Aggiungi le tue foto</span>
      </a>
    </div>

    <div id="grid" class="grid"></div>
  </div>

  <!-- MODAL -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="viewer" id="viewer">
      <button class="closebtn" id="closeBtn" aria-label="Chiudi">✕</button>
      <img id="bigImg" src="" alt="">
      <div class="viewer-footer">
        <button class="navbtn" id="prevBtn">←</button>
        <div class="meta" id="bigMeta"></div>
        <button class="navbtn" id="nextBtn">→</button>
      </div>
    </div>
  </div>

  <script>
    const FOTO_JSON_URL = "data/foto.json";
    let items = [];
    let currentIndex = -1;

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function openModal(idx){
      currentIndex = idx;
      const p = items[currentIndex];
      const modal = document.getElementById("modal");
      const img = document.getElementById("bigImg");
      const meta = document.getElementById("bigMeta");

      img.src = p.file;
      img.alt = "Foto";
      meta.textContent = `${p.name || "Anonimo"} · ${p.date || ""}`;

      modal.classList.add("open");
      modal.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
    }

    function closeModal(){
      const modal = document.getElementById("modal");
      modal.classList.remove("open");
      modal.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
    }

    function next(){
      if (!items.length) return;
      openModal((currentIndex + 1) % items.length);
    }
    function prev(){
      if (!items.length) return;
      openModal((currentIndex - 1 + items.length) % items.length);
    }

    async function loadAlbum(){
      const grid = document.getElementById("grid");
      grid.innerHTML = "";

      try{
        const res = await fetch(FOTO_JSON_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("foto.json non trovato");
        const data = await res.json();

        items = (Array.isArray(data) ? data : [])
          .filter(x => x && x.file && x.date)
          .sort((a,b) => String(b.date).localeCompare(String(a.date)));

        if (!items.length){
          grid.innerHTML = `<div style="opacity:.85;">Nessuna foto pubblicata.</div>`;
          return;
        }

        const html = items.map((p, idx) => `
          <div class="ph" data-idx="${idx}">
            <img src="${escapeHtml(p.file)}" alt="Foto"
                 loading="lazy" decoding="async">
          </div>
        `).join("");

        grid.innerHTML = html;

        // click su miniatura
        grid.querySelectorAll(".ph").forEach(el => {
          el.addEventListener("click", () => {
            const idx = Number(el.getAttribute("data-idx"));
            openModal(idx);
          });
        });

      } catch(e){
        console.error(e);
        grid.innerHTML = `<div style="opacity:.85;">Anteprima non disponibile.</div>`;
      }
    }

    // controlli modal
    document.getElementById("closeBtn").addEventListener("click", closeModal);
    document.getElementById("nextBtn").addEventListener("click", next);
    document.getElementById("prevBtn").addEventListener("click", prev);

    // chiudi cliccando fuori
    document.getElementById("modal").addEventListener("click", (e) => {
      if (e.target.id === "modal") closeModal();
    });

    // tastiera
    document.addEventListener("keydown", (e) => {
      const modalOpen = document.getElementById("modal").classList.contains("open");
      if (!modalOpen) return;
      if (e.key === "Escape") closeModal();
      if (e.key === "ArrowRight") next();
      if (e.key === "ArrowLeft") prev();
    });

    // swipe mobile (semplice)
    let touchX = null;
    document.getElementById("viewer").addEventListener("touchstart", (e) => {
      touchX = e.changedTouches[0].clientX;
    }, { passive:true });
    document.getElementById("viewer").addEventListener("touchend", (e) => {
      if (touchX == null) return;
      const dx = e.changedTouches[0].clientX - touchX;
      touchX = null;
      if (Math.abs(dx) < 40) return;
      if (dx < 0) next(); else prev();
    }, { passive:true });

    loadAlbum();
  </script>
</body>
</html>